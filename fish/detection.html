<!DOCTYPE html>
<html>
<head>
</head>
<body>

  <style>
    #playmarker {
      width:2px;
      height:600px;
      background:#0f0;
      z-index:99999;
      position:fixed;
      top:0;
      left:0;
    }
  </style>

  <div id="playmarker"></div>


  <canvas width="300" height="150" id="canvasElement"></canvas>
  <canvas width="300" height="150" id="canvasFiltered"></canvas>
  <canvas width="300" height="150" id="canvasOverlay"></canvas>
  
  <script type="text/javascript">
var context = new webkitAudioContext();

    



    var playmarker = document.getElementById("playmarker");

    var width = 300;

    var activeColumn = -1;

    var rows = 8;
    var columns = 16;

    var currentMatrix = [];
    var previousMatrix = [];
    var matrix = [];

    for (var i = 0; i < rows; i++) {
      var arr = [];
      for (var j = 0; j < columns; j++) {
        arr.push(false);
      }
      matrix.push(arr);
    }



    var notes = [
      "tones/tone1.wav",
      "tones/tone2.wav",
      "tones/tone3.wav",
      "tones/tone4.wav",
      "tones/tone5.wav",
      "tones/tone6.wav",
      "tones/tone7.wav",
      "tones/tone8.wav",
    ];

    playNote = function(index) {
      var audio = new Audio();
      audio.src = notes[index];
      audio.position = 0;
      audio.play();
    }






    // matrixUpdated = function() {
    // 
    // }
    // 
    // columnChange = function() {
    //   for (var i = 0, len = matrix[activeColumn].length; i < len; i++) {
    //     if (matrix[activeColumn][i] === true) {
    //       playNote(i);
    //     }
    //   }
    // }
    // 
    // 
    // movePlaymarker = function() {
    //   var left = playmarker.style.left.replace("px", "") * 1 + 10;
    //   if (left > width) {
    //     left = 0;
    //   }
    // 
    //   var newActiveColumn = parseInt(left / (width / columns));
    // 
    //   if (newActiveColumn !== activeColumn) {
    //     activeColumn = newActiveColumn;
    //     columnChange();
    //   }
    // 
    //   playmarker.style.left = left + "px";
    // }
    // 
    // setInterval(movePlaymarker, 10);





    var ctx = canvasElement.getContext('2d');
    var ctxOverlay = canvasOverlay.getContext('2d');
    var ctxFiltered = canvasFiltered.getContext('2d');

    var x, y;
    var width = 300;
    var height = 150

    function redraw() {
      ctx.clearRect(0,0,300,150);
      // ctx.fillStyle = "#FEBB26";
      ctx.fillStyle = "#0144D9";
      ctx.fillStyle = "#000";
      ctx.fillStyle = "#00FF00";
      
      // ctx.fillRect(0,0,300,150);
      
      var bg = new Image();
      // bg.src = "images/greenbg.jpg";
      // ctx.drawImage(bg, 0, 0, 425, 318, 0, 0, 300, 150)
      
      bg.src = "images/realtalk.png";
      // bg.src = "images/gay2.jpg";
      ctx.drawImage(bg, 0, 0, 746, 338, 0, 0, 300, 150)
      
      
      var i = fishes.length;
      while (i--) {
        var fish = fishes[i];
        var image = fish.image;
        
        if ((fish.y + image.height*0.25) > 150 || fish.y < 0) {
          fish.vy = fish.vy * -1
        }
        
        if ((fish.x + image.width*0.25) > 300 || fish.x < 0) {
          fish.vx = fish.vx * -1
        }
        
        fish.x += fish.vx;
        fish.y += fish.vy
        
        sh = image.height
        dh = image.height*0.25
        sy = 0;
        dy = fish.y;
        sx = 0
        dx = fish.x
        sw = image.width
        dw = image.width*0.25
        ctx.drawImage(image, sx, sy, sw, sh, dx, dy, dw, dh)
      }
    }
    
    setInterval(redraw, 30)
    
    function detect() {
      
      ctxOverlay.clearRect(0,0,300,150);
      ctxOverlay.fillStyle = "rgba(255,200,0,1)";
      
      var image = ctx.getImageData(0,0,300,150);
      var filteredImageData = chromaKeyFilter(image);
      
      var imageData = image.data;
      
      var rowHeight = height / rows;
      var columnWidth = width / columns;
      
      var newMatrix = [];
      
      // for each row
      for (var y=0; y < rows*rowHeight; y+=rowHeight) {
        var row = [];
        // for each column
        for (var x=0; x < columns*columnWidth; x+=columnWidth) {
          
          var filteredImageData = ctxFiltered.getImageData(x,y,columnWidth,rowHeight).data;
          // var filteredImageData = chromaKeyFilter(imageData);
          var total = 0;
          // for every pixel in the square
          for (var k=0; k < filteredImageData.length; k++) {
            if (filteredImageData[k+3] != 0) {
              total += 1
            }
          };
          
          var threshold = 800;
          if (total > threshold) {
            ctxOverlay.fillRect(x, y, columnWidth, rowHeight);
          }
          row.push(total > threshold);
        };
        newMatrix.push(row);
      };
      // lastMatrix = currentMatrix;
      // currentMatrix = newMatrix;
      // matrix = mergeMatrixes(lastMatrix, currentMatrix);
      
      matrix = newMatrix
      window.matrixUpdated && window.matrixUpdated(matrix);
    }
    setInterval(detect, 500)

    
    var yellowFish = new Image();
    yellowFish.src = "images/yellow.png";
    
    var fishes = [{
      image: yellowFish,
      x: 0,
      y: 10,
      vx: 0.5,
      vy: 0.4
    },{
      image: yellowFish,
      x: 70,
      y: 20,
      vx: 0.5,
      vy: 0.6
    }];

    function setMouse() {
      x = window.event.offsetX;
      y = window.event.offsetY; 
      redraw()
    }  
    canvasElement.onmousemove = setMouse
    
    function touchMove(event) {
      event.preventDefault();
      var touch = event.changedTouches[0];
      x = touch.pageX;  
      y = touch.pageY;
      redraw()
    }
    canvasElement.addEventListener("touchmove", touchMove, false);
    
    // function mergeMatrixes(matrix1, matrix2) {
    //   var mergedArray = [];
    //   for (var i=0; i < matrix1.length; i++) {
    //     var row1 = matrix1[i];
    //     var row2 = matrix2[i];
    //     var mergedRow = [];
    //     for (var j=0; j < row1.length; j++) {
    //       mergedRow.push(row1[j] || row2[j])
    //     };
    //   };
    //   return mergedArray;
    // }
    // 
    function chromaKeyFilter(image) {
      var l = image.data.length / 4;
      for (var i = 0; i < l; i++) {
        var r = image.data[i * 4 + 0];
        var g = image.data[i * 4 + 1];
        var b = image.data[i * 4 + 2];
        
        // if (g > 100 && r < 100 && b < 100)
          // image.data[i * 4 + 3] = 0;
        
        // If more green than others
        // if (g > r && g > b)
            // image.data[i * 4 + 3] = 0;
          
        
        // if orange
        // var hsl = rgbToHsl(r,g,b);
        //   if (hsl.h > 0.18 || hsl.h < 0.038) image.data[i * 4 + 3] = 0;
        //   if (hsl.s < 0.1) image.data[i * 4 + 3] = 0;
        //   if (hsl.l < 0.4) image.data[i * 4 + 3] = 0;
        
        // if not green
        var hsl = rgbToHsl(r,g,b);
          if (!(hsl.h > 0.5 || hsl.h < 0.17)) image.data[i * 4 + 3] = 0;
           if (hsl.s < 0.1) image.data[i * 4 + 3] = 0;
           if (hsl.l < 0.1) image.data[i * 4 + 3] = 0;
        
      }
      
      ctxFiltered.putImageData(image, 0, 0);
      
      return image.data;
    }
    
    
    
    
    function rgbToHsl(r, g, b){
        r /= 255, g /= 255, b /= 255;
        var max = Math.max(r, g, b), min = Math.min(r, g, b);
        var h, s, l = (max + min) / 2;

        if(max == min){
            h = s = 0; // achromatic
        }else{
            var d = max - min;
            s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
            switch(max){
                case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                case g: h = (b - r) / d + 2; break;
                case b: h = (r - g) / d + 4; break;
            }
            h /= 6;
        }

        return {h:h, s:s, l:l};
    }
  </script>
  
  <style type="text/css" media="screen">
/*    canvas {
      position: absolute;
      top: 0;
      left: 0;
    }*/
    canvas {
      border: 1px solid black;
    }
  </style>
</body>
</html>